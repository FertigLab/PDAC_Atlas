---
title: "12H_MultiSeq_02_AddingMoffitAnnotations"
author: "Joe"
date: "1/21/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Load packages
```{r}
library(Seurat)
library(ggplot2)
library(ggpubr)
```

##Load data
```{r}
load(file="PDAC/Data/12H_MultiSeq_ProjR_InflammationData.rda")
```

##Code adapted from Atlas @Ben

##Classical Features
```{r}
##list of Classical Features
Moffitt_classical_features <- list(c("BTNL8","FAM3D","PRR15L","AGR3","CTSE","LOC400573","LYZ","TFF2","TFF1","ANXA10","LGALS4","PLA2G10","CEACAM6","VSIG2","TSPAN8","ST6GALNAC1","AGR2","TFF3","CYP3A7","MYO1A","CLRN3","KRT20","CDH17","SPINK4","REG4"))

#make data frame
Moffitt_classical_features_df <- as.data.frame(Moffitt_classical_features)
colnames(Moffitt_classical_features_df) <- "V1"
length(Moffitt_classical_features_df$V1)

#Classical features in/not present in counts matrix of 12HR multiseq
classical_not_in_gene_metadata <- Moffitt_classical_features_df %>% pull(V1) %>% .[!(. %in% rownames(dgeData_scaled@assays$RNA@counts))]
classical_in_gene_metadata <- Moffitt_classical_features_df %>% pull(V1) %>% .[. %in% rownames(dgeData_scaled@assays$RNA@counts)]
```

##Basal Features
```{r}
##list of Basal Features
Moffitt_basal_features <- list(c("VGLL1","UCA1","S100A2","LY6D","SPRR3","SPRR1B","LEMD1","KRT15","CTSV","DHRS9","AREG","CST6","SERPINB3","KRT6C","KRT6A","SERPINB4","FAM83A","SCEL","FGFBP1","KRT7","KRT17","GPR87","TNS4","SLC2A1","ANXA8L2"))

#make data frame
Moffitt_basal_features_df <- as.data.frame(Moffitt_basal_features)
colnames(Moffitt_basal_features_df) <- "V1"
length(Moffitt_basal_features_df$V1)

#Basal features in/not present in counts matrix of 12HR multiseq
basal_not_in_gene_metadata <- Moffitt_basal_features_df %>% pull(V1) %>% .[!(. %in% rownames(dgeData_scaled@assays$RNA@counts))]
basal_in_gene_metadata <- Moffitt_basal_features_df %>% pull(V1) %>% .[. %in% rownames(dgeData_scaled@assays$RNA@counts)]
```

##iCAF Features
```{r}
##list of iCAF Features
Jackie_iCAF_features <- list(c("CXCL1","CXCL2","CCL2","CXCL12","PDGFRA","CFD","LMNA","DPT","HAS1","HAS2"))

#make data frame
Jackie_iCAF_features_df <- as.data.frame(Jackie_iCAF_features)
colnames(Jackie_iCAF_features_df) <- "V1"
length(Jackie_iCAF_features_df$V1)

#iCAF features in/not present in counts matrix of 12HR multiseq
iCAF_not_in_gene_metadata <- Jackie_iCAF_features_df %>% pull(V1) %>% .[!(. %in% rownames(dgeData_scaled@assays$RNA@counts))]
iCAF_in_gene_metadata <- Jackie_iCAF_features_df %>% pull(V1) %>% .[. %in% rownames(dgeData_scaled@assays$RNA@counts)]
```

##myCAF Features
```{r}
##list of myCAF features
Jackie_myCAF_features <- list(c("aSMA","TAGLN","MYL9","TPM2","MMP11","POSTN","HOPX","TWIST1","SOX4","ZUB1"))

#make data frame
Jackie_myCAF_features_df <- as.data.frame(Jackie_myCAF_features)
colnames(Jackie_myCAF_features_df) <- "V1"
length(Jackie_myCAF_features_df$V1)

#myCAF features in/not present in counts matrix of 12HR multiseq
myCAF_not_in_gene_metadata <- Jackie_myCAF_features_df %>% pull(V1) %>% .[!(. %in% rownames(dgeData_scaled@assays$RNA@counts))]
myCAF_in_gene_metadata <- Jackie_myCAF_features_df %>% pull(V1) %>% .[. %in% rownames(dgeData_scaled@assays$RNA@counts)]
```

# geneset scores
```{r}
##Subset Multiseq for org pops
Org_Clust <- dgeData_scaled[,(dgeData_scaled$Classification %in% c("Org1","CC_Org"))]

#Add module scores for Classical and Basal features
Org_Clust <- AddModuleScore(object = Org_Clust,features = Moffitt_classical_features, name = "Classical")
Org_Clust <- AddModuleScore(object = Org_Clust,features = Moffitt_basal_features,name = "Basal")

##Subset Multiseq for caf pops
CAF_Clust <- dgeData_scaled[,(dgeData_scaled$Classification %in% c("CAF1","CC_CAF"))]

##Add module scores for iCAF and myCAF features
CAF_Clust <- AddModuleScore(object = CAF_Clust,features = Jackie_iCAF_features, name = "iCAF")
CAF_Clust <- AddModuleScore(object = CAF_Clust,features = Jackie_myCAF_features, name = "myCAF")
```

# extract gene set scores from seurat object and scale ModuleScores (found that scale function helps to approximate ranges of individual ModuleScores for comparability)
```{r}
##Select column that contains the classical module scores, create new object
classical_4 <- select(Org_Clust@meta.data,11)
classical_4 <- cbind(rownames(classical_4),classical_4)
colnames(classical_4) <- c("rownames","Classical1")
classical_4 <- classical_4[order(match(classical_4$rownames,rownames(dgeData_scaled@meta.data))),]

##Select column that contains the basal module scores, create new object
basal_4 <- select(Org_Clust@meta.data,12)
basal_4 <- cbind(rownames(basal_4),basal_4)
colnames(basal_4) <- c("rownames","Basal1")
basal_4 <- basal_4[order(match(basal_4$rownames,rownames(dgeData_scaled@meta.data))),]

##Select column that contains the iCAF module scores, create new object
iCAF_4 <- select(CAF_Clust@meta.data,11)
iCAF_4 <- cbind(rownames(iCAF_4),iCAF_4)
colnames(iCAF_4) <- c("rownames","iCAF1")
iCAF_4 <- iCAF_4[order(match(iCAF_4$rownames,rownames(dgeData_scaled@meta.data))),]

##Select column that contains the myCAF module scores, create new object
myCAF_4 <- select(CAF_Clust@meta.data,12)
myCAF_4 <- cbind(rownames(myCAF_4),myCAF_4)
colnames(myCAF_4) <- c("rownames","myCAF1")
myCAF_4 <- myCAF_4[order(match(myCAF_4$rownames,rownames(dgeData_scaled@meta.data))),]

##Scale the module scores
classical_4$Classical1 <- scale(classical_4$Classical1, center=FALSE)
basal_4$Basal1 <- scale(basal_4$Basal1, center=FALSE)
iCAF_4$iCAF1 <- scale(iCAF_4$iCAF1, center=FALSE)
myCAF_4$myCAF1 <- scale(myCAF_4$myCAF1, center=FALSE)
```

# integrate module scores into Multiseq metadata
```{r}
##Duplicate metadata and Org/Caf data from above
explore_meta <- data.frame(dgeData_scaled@meta.data)
org_meta <-data.frame(Org_Clust@meta.data)
CAF_meta <-data.frame(CAF_Clust@meta.data)

##Mutate org_meta to indicate Epithelial (Classical vs Basal) annotations
org_meta <- mutate(org_meta, "Classifier_Epithelial" = ifelse(classical_4$Classical1 > 0 & basal_4$Basal1 > 0, "dual_positive", ifelse(classical_4$Classical1 > 0 & basal_4$Basal1 < 0, "Classical", ifelse(classical_4$Classical1 < 0 & basal_4$Basal1 > 0, "Basal", ifelse(classical_4$Classical1 < 0 & basal_4$Basal1 < 0, "dual_negative", NA)))))

##Mutate CAF_meta to indicate CAF (iCAF vs myCAF) annotations
CAF_meta <- mutate(CAF_meta, "Classifier_CAF" = ifelse(iCAF_4$iCAF1 > 0 & myCAF_4$myCAF1 > 0, "dual_positive", ifelse(iCAF_4$iCAF1 > 0 & myCAF_4$myCAF1 < 0, "iCAF", ifelse(iCAF_4$iCAF1 < 0 & myCAF_4$myCAF1 > 0, "myCAF", ifelse(iCAF_4$iCAF1 < 0 & myCAF_4$myCAF1 < 0, "dual_negative", NA)))))

##Create vector of Epithelial annotations
Classifier_Epithelial <- org_meta$Classifier_Epithelial
rownames(Classifier_Epithelial) <- rownames(org_meta)
colnames(Classifier_Epithelial) <- "Classifier_Epithelial"

##Create vector of CAF annotations
Classifier_CAF <- CAF_meta$Classifier_CAF
rownames(Classifier_CAF) <- rownames(CAF_meta)
colnames(Classifier_CAF) <- "Classifier_CAF"

##Combine the CAF multiseq annotations with the iCAF/myCAF annotations (this will help us distinguish the mono vs coculture populations later)
CAF_meta$Classifier_CAF_Specific <- paste(CAF_meta$MULTIseqClassification,CAF_meta$Classifier_CAF, sep="_")
CAF_Clust@meta.data <- CAF_meta
```

##Add % variable to find the percentage of Basal/Classical/DualPos/DualNeg for the epithelial and iCAF/myCAF/dualPos/dualNeg for the CAF
```{r}
org_pct <- org_meta%>%
  dplyr::group_by(Classification,Classifier_Epithelial)%>%
  dplyr::tally()%>%
  dplyr::mutate(percent=n/sum(n))

caf_pct <- CAF_meta%>%
  dplyr::group_by(Classification,Classifier_CAF)%>%
  dplyr::tally()%>%
  dplyr::mutate(percent=n/sum(n))

```


##Stacked Barplot for Org and CAF subtypes
```{r}
pdf(file="PDAC/Figures/MultiSeq12H_BasalClass_iCAFmyCAF_stackedbarplots.pdf")
ggplot(org_pct, aes(fill=Classifier_Epithelial, y=n, x=Classification)) + 
    geom_col(position="fill") + ggtitle("Organoid Basal/Classical Distribution Across Condition") + labs(y="percent_counts") +
    geom_text(aes(label=paste0(sprintf("%1.1f", percent*100),"%")),
                     position=position_fill(vjust=0.5), colour="black", size =3)


ggplot(caf_pct, aes(fill=Classifier_CAF, y=n, x=Classification)) + 
    geom_col(position="fill") + ggtitle("CAF iCAF/myCAF Distribution Across Condition") + labs(y="percent_counts") +
    geom_text(aes(label=paste0(sprintf("%1.1f", percent*100),"%")),
                     position=position_fill(vjust=0.5), colour="black", size =3)
dev.off()
```

##Violin Plots of ITGB1 Expression in iCAF/myCAF populations -- not sure if included in this paper
```{r}
VlnPlot(CAF_Clust, features = "ITGB1", group.by = "Classifier_CAF_Specific",y.max=7.5) + stat_compare_means(comparisons= list(c("CAF1_iCAF","CAF1_myCAF"),c("CC1_iCAF","CC1_myCAF"),c("CAF1_iCAF","CC1_myCAF"),c("CAF1_myCAF","CC1_myCAF"),c("CAF1_iCAF","CC1_iCAF"),c("CAF1_iCAF","CC1_myCAF")), label.y.npc = 0.85, method = "wilcox.test")
```


